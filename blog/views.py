from django.shortcuts import render, get_object_or_404
from django.shortcuts import redirect
from django.utils import timezone
from .models import Post
from .models import Anime
from .forms import PostForm
from .forms import AnimeForm
from django.http import HttpResponse
from django.core import serializers
from django.core.files import File
import time


def post_list(request):
    print("lol1")
    if request.is_ajax():
        print ("ajax")
        return render(request, 'blog/Site.html/')
    if request.method == "POST":
        print("lol")
    return render(request, 'blog/Site.html')

def post_detail(request, pk):
    post = get_object_or_404(Post, pk=pk)
    return render(request, 'blog/post_detail.html', {'post': post})

def animez(request):
    print('rawr')
   # initialize(request)
    #If the call method is post, then it will do stuff
    if request.method == "POST":
        print('rawr3')
        anim = Anime()
       # f = open('shows', 'rw')
        #changeFile(request)
        #readFile(f, request)
       # anim.findOnNetflix()
        test = anim.contains(request.POST.get('name'))
       
        return HttpResponse(serializers.serialize("json",test))
#This was used to add all initial netflix shows

def initialize(request):
        shows = []
        print('here')
        form = AnimeForm()
        anim = Anime()
        print('here2')
        hulu = anim.findOnHulu();
        netflix = anim.findOnNetflix();       
        crunchy = anim.findOnCR();
        print('here3')
        
        #total = [line.rstrip('\n') for line in open('shows')]
        total = netflix + crunchy + hulu
        print(total)
        nets = False
        crunch = False
        hulz = False
        for name in total:
            form = AnimeForm()
            print('eh')
            if (form.is_valid()):
                if name in shows:
                    print ("nope")
                else:
                    print (name)
                    show = form.save(commit = False)
                    show.title = name
                    show.crunchy = False
                    show.hulu = False
                    show.netflix = False
                    if name in crunchy:
                        show.crunchy = True
                    if name in hulu:
                        show.hulu = True
                    for line in netflix:
                        show.netflix = True
                    show.funi = False
                    error = anim.setImage(name)
                    print('here2')
                    if (error == 1):
                        show.image = "posters/" + name + ".jpeg"
                        print('imaged')
                    if (error == -1):
                        show.image = "posters/nope.jpeg"
                        print('imaged fail')
                    print('saved')
                    shows.append(name)
                    print('eh3')
                    show.save()
                    print('eh2')
                    print('done')
def changeFile(request):
    crunchy = open('crunchyroll','r')
    hulu = open('hulu','r')
    netflix = open('netflix','r')
    crunchy2 = open('crunchyroll2','a')
    hulu2 = open('hulu2','a')
    netflix2 = open('netflix2','a')
    for line in crunchy:
        crunchy2.write(line + "\n")
    for line in hulu:
        hulu2.write(line + "\n")
    for line in netflix:
        netflix2.write(line + "\n")
def readFile(f, request):
    print('got to read')
    crunchy = open('crunchyroll','r')
    hulu = open('hulu','r')
    netflix = open('netflix','r')
    netflix2 = open('netflix2','rw')
    net2 = []
    for line in netflix:
        print(line)
        net2.append(line)
    print(net2[0])
    for line in f:
        netflix2 = open('netflix2','rw')
        crunchy2 = open('crunchyroll2','rw')
        hulu2 = open('hulu2','rw')
        #line = line.rstrip('\n')
        c = False
        n = False
        h = False
        if "*" not in line:
            print(line)
           
            
            for line2 in netflix2:
               # print("line2" + line2 + "    " + "line" + line)
                if (line2.lower() == line.lower()):
                    print('Ngotem')
                    n = True
                    break
            for line2 in hulu2:
                #print("line2" + line2 + "    " + "line" + line)
                if (line2.lower() == line.lower()):
                    print('Hgotem')
                    h = True
                    break
            for line2 in crunchy2:
                #print("line2" + line2 + "    " + "line" + line)
                if (line2.lower() == line.lower()):
                    print('Cgotem')
                    c = True
                    break
            makeShow(line, request, c, h, n)
def makeShow(name,request, c, h, n):
    print('name')
    anim = Anime()
    form = AnimeForm(request.POST)
    if (form.is_valid()):
        print('eh?')
        show = form.save(commit = False)
        show.title = name
        show.crunchy = c
        show.hulu = h
        show.netflix = n
        show.funi = False
        print('a')
        error = anim.setImage(name)
        print('a')
        if (error == 1):
            show.image = "posters/" + name.replace(" ", "") + ".jpeg"
            print ('imaged' + name)
        else:
            show.image = "posters/nope.jpeg"
            print('image failed ' + name)
        print('abc')
        time.sleep(0.5)
        show.save()
        
        
def start(request):
    for s in shows:
        anim = Anime()
        form = AnimeForm(request.POST)
        if (form.is_valid()):
            print (s)
            year = s[s.find('(') + 1: -1]
            print(year)          
            s = s[0:s.find("(")]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            test = anim.contains(s)
            if (len(test) > 0):
                print('nope')
            else:
                show = form.save(commit = False)
                show.title = s
                show.crunchy = anim.findOnCR(s)
                show.hulu = anim.findOnHulu(s)
                show.funi = False
                show.netflix = True

                show.year = year
                print('wut')
                error = anim.setImage(s, year)
                print('wut2')
                if (error == 0):
                    show.image = "posters/" + s + ".jpeg"
                if (error == -1):
                    show.image = "posters/nope.jpeg"
                print('wut3')
                show.save()
         
       


def post_new(request):
    if request.method == "POST":
        form = PostForm(request.POST)
        if form.is_valid():
            
            post = form.save(commit=False)
            post.text = anim.findOnCR('Oreimo')
            post.author = request.user
            post.published_date =  timezone.now()
            post.save()
            
            return redirect('blog.views.post_detail', pk=post.pk) 
    else:
        form = PostForm()
    return render(request, 'blog/post_edit.html', {'form': form})